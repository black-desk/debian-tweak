# vim:ft=sh

. /etc/systemd/system-environment-generators/00-io.github.black-desk.debian-tweak

if [ -z "$IO_GITHUB_BLACKDESK_DEBIANTWEAK_IS_THINKPAD_L14_GEN2" ]; then
        return
fi

echo "Update grub configuration for my Thinkpad L14 Gen2..."

# NOTE:
# I don't want to wait for 30 seconds when booting.
# shellcheck disable=SC2034
GRUB_TIMEOUT=0
# NOTE:
# I use btrfs /boot, which fs grub will not able to write to,
# in such case grub recordfail feature is disabled,
# and grub.cfg generated by /etc/grub.d/00_header will
# set timeout to GRUB_RECORDFAIL_TIMEOUT:
# /boot/grub/grub.cfg:
# > ```
# > function recordfail {
# >   set recordfail=1
# >   # GRUB lacks write support for btrfs, so recordfail support is disabled.
# > }
# > ```
# /etc/grub.d/00_header:
# > ```
# > if [ "\${recordfail}" = 1 ] ; then
# >   set timeout=${GRUB_RECORDFAIL_TIMEOUT:-30}
# > ```
# So it's not enough to only set GRUB_TIMEOUT.
# shellcheck disable=SC2034
GRUB_RECORDFAIL_TIMEOUT=0

# NOTE:
# Thinkpad L14 Gen2 (AMD) has an issue that make laptop cannot sleep to mem.
# https://www.reddit.com/r/thinkpad/comments/pdpg48/lenovo_thinkpad_l14_gen2_amd_linux/?rdt=36574
# We have to make kernel default to s2idle.
GRUB_CMDLINE_LINUX=${GRUB_CMDLINE_LINUX}${GRUB_CMDLINE_LINUX:+ }'\
mem_sleep_default=s2idle'

# NOTE:
# My new SSD from Yangtze Memory Technologies seems to have some issue.
# I disable some powersave feature in kernel then it works fine.
GRUB_CMDLINE_LINUX=${GRUB_CMDLINE_LINUX}${GRUB_CMDLINE_LINUX:+ }'\
pcie_aspm=off \
nvme_core.default_ps_max_latency_us=0'

echo "Done."
